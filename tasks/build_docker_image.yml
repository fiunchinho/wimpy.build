---

- name: "Log into private registry"
  docker_login:
    registry: "{{ wimpy_docker_registry | default(omit) }}"
    email: "{{ wimpy_docker_registry_email | default(none) }}"
    username: "{{ wimpy_docker_registry_username }}"
    password: "{{ wimpy_docker_registry_password }}"
    reauthorize: yes
  when:
    - not wimpy_docker_skip_login

- name: "Build and push docker image"
  docker_image:
    path: "{{ lookup('env','PWD') }}"
    name: "{{ wimpy_docker_image_name }}:{{ wimpy_release_version | string }}"
    push: yes
    force: "{{ wimpy_docker_image_force }}"
    buildargs: "{{ wimpy_docker_build_args }}"

- name: "Build and push latest tag"
  docker_image:
    path: "{{ lookup('env','PWD') }}"
    name: "{{ wimpy_docker_image_name }}:latest"
    push: yes
    force: "{{ wimpy_docker_image_force }}"
    buildargs: "{{ wimpy_docker_build_args }}"
  when:
    - wimpy_docker_image_tag_latest

- name: "Delete local image built"
  docker_image:
    name: "{{ wimpy_docker_image_name }}:{{ wimpy_release_version | string }}"
    state: absent
    push: no
  when:
    - wimpy_docker_image_delete_after_build

- name: "Delete local image built (latest)"
  docker_image:
    name: "{{ wimpy_docker_image_name }}:latest"
    state: absent
    push: no
  when:
    - wimpy_docker_image_delete_after_build
    - wimpy_docker_image_tag_latest
